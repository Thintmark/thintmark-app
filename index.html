import React, { useEffect, useMemo, useRef, useState } from "react";

// Product Promo Text-to-Image Prompt Builder (fixed)
// Fixes made:
// 1. Replaced deprecated/unsafe use of escape/unescape with robust base64 unicode encode/decode helpers.
// 2. Removed embedded CSS using @apply (which can break if not processed) and used direct Tailwind utility classes instead.
// 3. Made clipboard copy resilient with a fallback for environments without navigator.clipboard.
// 4. Removed use of alert() and added an in-UI notification so the app doesn't rely on blocking dialogs.
// 5. Defensive checks for browser APIs to avoid ReferenceError (e.g. in SSR / non-browser envs).

// --- utils: safe base64 encode/decode for Unicode strings ---
const base64EncodeUnicode = (str) => {
  // https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/btoa#unicode_strings
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (match, p1) {
    return String.fromCharCode(parseInt(p1, 16));
  }));
};

const base64DecodeUnicode = (b64) => {
  return decodeURIComponent(
    atob(b64)
      .split("")
      .map(function (c) {
        return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
      })
      .join("")
  );
};

const encodeState = (obj) => {
  try {
    const json = JSON.stringify(obj);
    return base64EncodeUnicode(json);
  } catch (e) {
    console.error("Failed to encode state:", e);
    return "";
  }
};
const decodeState = (str) => {
  try {
    const json = base64DecodeUnicode(str);
    return JSON.parse(json);
  } catch (e) {
    console.error("Failed to decode state:", e);
    return null;
  }
};

const CAMERAS = [
  "Smartphone (flagship 2024)",
  "Mirrorless APS-C (entry)",
  "Mirrorless Full-Frame (pro)",
  "DSLR Full-Frame (pro)",
  "Medium Format (ultra detail)"
];

const LENSES = [
  "Standard 50mm (natural look)",
  "Macro 100mm (extreme detail)",
  "Wide 24mm (context & scene)",
  "Tele 85mm (compression & bokeh)",
  "Tilt-Shift 90mm (product control)"
];

const DISTANCES = [
  "Close-up (10–20 cm)",
  "Near (20–40 cm)",
  "Mid (40–80 cm)",
  "Far (80+ cm)"
];

const ANGLES = [
  "Eye-level front",
  "45° front-top",
  "Top-down (flatlay)",
  "Low angle (hero)",
  "Side profile",
  "Three-quarter view"
];

const LIGHTING = [
  "Softbox diffused, warm",
  "Hard light, high-contrast",
  "Backlit rim light",
  "Window light (natural)",
  "Studio 3-point setup",
  "Moody low-key",
  "High-key evenly lit",
  "Uneven lighting / chiaroscuro",
  "Spotlight on product",
  "Golden hour simulation"
];

const COMPOSITIONS = [
  "Rule of thirds",
  "Centered symmetry",
  "Leading lines",
  "Negative space",
  "Golden ratio",
  "Diagonal composition",
  "Triangle layout",
  "Top-left focal point",
  "Right-third product focus"
];

const FOCUS_VIEWS = [
  "Front view",
  "Back view",
  "Left side",
  "Right side",
  "Top view",
  "Bottom view",
  "Exploded detail (macro)"
];

const DEFAULT_STATE = {
  description: "",
  useReferenceImage: false,
  focusView: "Front view",
  camera: CAMERAS[2],
  lens: LENSES[0],
  distance: DISTANCES[1],
  angle: ANGLES[1],
  lighting: [LIGHTING[0], LIGHTING[8]],
  composition: [COMPOSITIONS[0]],
  unevenLighting: false,
  styleNotes: "commercial product ad, crisp, clean background, realistic textures, accurate brand colors",
};

export default function App() {
  const [state, setState] = useState(DEFAULT_STATE);
  const [imageName, setImageName] = useState("");
  const [notice, setNotice] = useState("");
  const fileRef = useRef(null);

  // load state from URL if present (defensive: only run in browser)
  useEffect(() => {
    try {
      if (typeof window === "undefined") return;
      const params = new URLSearchParams(window.location.search);
      const packed = params.get("d");
      if (packed) {
        const restored = decodeState(packed);
        if (restored) {
          setState((prev) => ({ ...DEFAULT_STATE, ...restored }));
        }
      }
    } catch (e) {
      console.error(e);
    }
  }, []);

  // computed prompts
  const jsonPrompt = useMemo(() => {
    return {
      product_description: state.description,
      use_reference_image: state.useReferenceImage,
      reference_image_hint: state.useReferenceImage ? "Match product form, color, and material to the uploaded reference image." : "No reference image; generate from description only.",
      focus_view: state.focusView,
      camera: state.camera,
      lens: state.lens,
      subject_distance: state.distance,
      camera_angle: state.angle,
      lighting: state.lighting,
      composition: state.composition,
      uneven_lighting_allowed: state.unevenLighting,
      style_notes: state.styleNotes,
      output_goal: "High-impact product advertising image suitable for social ads and marketplace listing thumbnails."
    };
  }, [state]);

  const promptEN = useMemo(() => {
    const parts = [];
    parts.push(`Commercial product photo of: ${state.description || "<describe your product>"}.`);
    if (state.useReferenceImage) {
      parts.push("Match form, color, material to the uploaded reference image.");
    }
    parts.push(`Focus: ${state.focusView}.`);
    parts.push(`Camera: ${state.camera}; Lens: ${state.lens}; Subject distance: ${state.distance}.`);
    parts.push(`Camera angle: ${state.angle}.`);
    parts.push(`Lighting: ${state.lighting.join(", ")}${state.unevenLighting ? ", allow uneven lighting / chiaroscuro" : ""}.`);
    parts.push(`Composition: ${state.composition.join(", ")}.`);
    parts.push(`Style: ${state.styleNotes}.`);
    parts.push("Sharp details, true-to-life colors, minimal noise, suitable for ads.");
    return parts.join(" ");
  }, [state]);

  const promptID = useMemo(() => {
    const parts = [];
    parts.push(`Foto produk komersial untuk: ${state.description || "<jelaskan produk Anda>"}.`);
    if (state.useReferenceImage) {
      parts.push("Samakan bentuk, warna, dan material dengan gambar referensi yang diunggah.");
    }
    parts.push(`Fokus: ${state.focusView}.`);
    parts.push(`Kamera: ${state.camera}; Lensa: ${state.lens}; Jarak subjek: ${state.distance}.`);
    parts.push(`Sudut kamera: ${state.angle}.`);
    parts.push(`Pencahayaan: ${state.lighting.join(", ")}${state.unevenLighting ? ", izinkan pencahayaan tidak merata / chiaroscuro" : ""}.`);
    parts.push(`Komposisi: ${state.composition.join(", ")}.`);
    parts.push(`Gaya: ${state.styleNotes}.`);
    parts.push("Detail tajam, warna akurat, noise minimal, cocok untuk iklan.");
    return parts.join(" ");
  }, [state]);

  const copyToClipboard = async (text) => {
    // resilient copy: try navigator.clipboard first, fallback to textarea + execCommand
    if (!text) return false;
    try {
      if (typeof navigator !== "undefined" && navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch (e) {
      console.warn("navigator.clipboard failed", e);
    }
    // fallback
    try {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "absolute";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return Boolean(ok);
    } catch (e) {
      console.error("Fallback copy failed", e);
      return false;
    }
  };

  const updateQS = async () => {
    try {
      const packed = encodeState(state);
      if (typeof window === "undefined") return;
      const url = new URL(window.location.href);
      url.searchParams.set("d", packed);
      window.history.replaceState({}, "", url.toString());
      const ok = await copyToClipboard(url.toString());
      setNotice(ok ? "Link disalin ke clipboard." : "Gagal menyalin link — silakan salin manual.");
      // clear notice after a short delay
      setTimeout(() => setNotice(""), 3000);
    } catch (e) {
      console.error(e);
      setNotice("Terjadi kesalahan saat membuat link.");
      setTimeout(() => setNotice(""), 3000);
    }
  };

  const copy = async (text) => {
    const ok = await copyToClipboard(text);
    setNotice(ok ? "Teks disalin ke clipboard." : "Gagal menyalin teks — silakan salin manual.");
    setTimeout(() => setNotice(""), 2500);
  };

  const reset = () => setState(DEFAULT_STATE);

  const handleFile = (e) => {
    const f = e?.target?.files?.[0];
    if (f) setImageName(f.name);
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-900 p-4 md:p-8">
      <div className="max-w-6xl mx-auto">
        <header className="mb-6">
          <h1 className="text-2xl md:text-4xl font-bold tracking-tight">Product Promo Text‑to‑Image Prompt Builder</h1>
          <p className="text-sm md:text-base text-gray-600 mt-2">Fokus pada pembuatan gambar promosi produk yang siap dipakai di Nano Banana atau generator gambar lain.</p>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* LEFT: Form */}
          <section className="lg:col-span-2 space-y-4">
            <Card>
              <CardTitle>1) Deskripsi Produk</CardTitle>
              <textarea
                className="w-full px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900"
                rows={4}
                placeholder="Contoh: Burger premium dengan keju meleleh, roti brioche, saus truffle, background bersih putih..."
                value={state.description}
                onChange={(e) => setState({ ...state, description: e.target.value })}
              />
            </Card>

            <Card>
              <CardTitle>2) Referensi Gambar (opsional)</CardTitle>
              <div className="flex items-center gap-3">
                <input
                  id="useRef"
                  type="checkbox"
                  className="h-4 w-4"
                  checked={state.useReferenceImage}
                  onChange={(e) => setState({ ...state, useReferenceImage: e.target.checked })}
                />
                <label htmlFor="useRef" className="text-sm">Gunakan produk sesuai gambar yang di‑upload</label>
              </div>
              <div className="mt-3">
                <input ref={fileRef} type="file" accept="image/*" onChange={handleFile} className="block text-sm" />
                {imageName && <p className="text-xs text-gray-500 mt-1">File: {imageName} (tidak diproses; hanya sebagai referensi pembuatan prompt)</p>}
              </div>
            </Card>

            <Card>
              <CardTitle>3) Sudut/Area Produk yang Difokuskan</CardTitle>
              <Select options={FOCUS_VIEWS} value={state.focusView} onChange={(v) => setState({ ...state, focusView: v })} />
            </Card>

            <Card>
              <CardTitle>4) Kamera</CardTitle>
              <Select options={CAMERAS} value={state.camera} onChange={(v) => setState({ ...state, camera: v })} />
            </Card>

            <Card>
              <CardTitle>5) Lensa</CardTitle>
              <Select options={LENSES} value={state.lens} onChange={(v) => setState({ ...state, lens: v })} />
            </Card>

            <Card>
              <CardTitle>6) Jarak Subjek ke Kamera</CardTitle>
              <Select options={DISTANCES} value={state.distance} onChange={(v) => setState({ ...state, distance: v })} />
            </Card>

            <Card>
              <CardTitle>7) Sudut Kamera</CardTitle>
              <Select options={ANGLES} value={state.angle} onChange={(v) => setState({ ...state, angle: v })} />
            </Card>

            <Card>
              <CardTitle>8) Pencahayaan</CardTitle>
              <MultiSelect
                options={LIGHTING}
                value={state.lighting}
                onChange={(v) => setState({ ...state, lighting: v })}
              />
              <div className="mt-3 flex items-center gap-2">
                <input
                  id="uneven"
                  type="checkbox"
                  className="h-4 w-4"
                  checked={state.unevenLighting}
                  onChange={(e) => setState({ ...state, unevenLighting: e.target.checked })}
                />
                <label htmlFor="uneven" className="text-sm">Izinkan pencahayaan tidak merata</label>
              </div>
            </Card>

            <Card>
              <CardTitle>9) Komposisi</CardTitle>
              <MultiSelect
                options={COMPOSITIONS}
                value={state.composition}
                onChange={(v) => setState({ ...state, composition: v })}
              />
            </Card>

            <Card>
              <CardTitle>Catatan Gaya (opsional)</CardTitle>
              <input
                className="w-full px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900"
                placeholder="Misal: glossy highlight, bayangan lembut, latar putih bersih / gradient, label jelas"
                value={state.styleNotes}
                onChange={(e) => setState({ ...state, styleNotes: e.target.value })}
              />
            </Card>

            <div className="flex flex-wrap gap-3">
              <button className="inline-flex items-center justify-center px-3 py-2 rounded-xl border border-gray-300 text-sm hover:bg-gray-50" onClick={reset}>Reset</button>
              <button className="inline-flex items-center justify-center px-3 py-2 rounded-xl border bg-gray-900 text-white text-sm" onClick={updateQS}>Share Link</button>
            </div>
          </section>

          {/* RIGHT: Output */}
          <section className="lg:col-span-1 space-y-4">
            <Card>
              <CardTitle>Output Prompt (English)</CardTitle>
              <textarea className="w-full px-3 py-2 rounded-xl border border-gray-300 font-mono" rows={8} readOnly value={promptEN} />
              <button className="w-full mt-2 inline-flex items-center justify-center px-3 py-2 rounded-xl border border-gray-300 text-sm hover:bg-gray-50" onClick={() => copy(promptEN)}>Copy English</button>
            </Card>

            <Card>
              <CardTitle>Output Prompt (Bahasa Indonesia)</CardTitle>
              <textarea className="w-full px-3 py-2 rounded-xl border border-gray-300 font-mono" rows={8} readOnly value={promptID} />
              <button className="w-full mt-2 inline-flex items-center justify-center px-3 py-2 rounded-xl border border-gray-300 text-sm hover:bg-gray-50" onClick={() => copy(promptID)}>Copy Bahasa</button>
            </Card>

            <Card>
              <CardTitle>JSON Prompt</CardTitle>
              <pre className="w-full px-3 py-2 rounded-xl border border-gray-300 font-mono whitespace-pre-wrap">{JSON.stringify(jsonPrompt, null, 2)}</pre>
              <button className="w-full mt-2 inline-flex items-center justify-center px-3 py-2 rounded-xl border border-gray-300 text-sm hover:bg-gray-50" onClick={() => copy(JSON.stringify(jsonPrompt))}>Copy JSON</button>
            </Card>

            <Card>
              <CardTitle>Tips Cepat</CardTitle>
              <ul className="list-disc pl-5 text-sm text-gray-700 space-y-1">
                <li>Gunakan <em>Macro 100mm</em> untuk detail tekstur (makanan, minuman, kosmetik).</li>
                <li><em>Top-down</em> cocok untuk flatlay dan kemasan.</li>
                <li><em>High-key</em> untuk marketplace; <em>Moody low-key</em> untuk iklan premium.</li>
                <li>Tambah komposisi <em>Negative space</em> jika ingin tempat untuk teks.</li>
              </ul>
            </Card>
          </section>
        </div>

        <footer className="mt-8 text-xs text-gray-500">
          <p>Catatan: File gambar yang diunggah tidak diproses oleh aplikasi ini. Gunakan prompt yang dihasilkan untuk Nano Banana atau generator lain.</p>
        </footer>

        {/* inline notice */}
        {notice && (
          <div className="mt-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200 text-sm text-yellow-900">{notice}</div>
        )}
      </div>
    </div>
  );
}

// --- UI primitives (use Tailwind utility classes inline to avoid depending on a <style> block) ---
function Card({ children }) {
  return <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-4">{children}</div>;
}
function CardTitle({ children }) {
  return <h2 className="text-base font-semibold mb-2">{children}</h2>;
}

function Select({ options, value, onChange }) {
  return (
    <select
      className="w-full px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-900"
      value={value}
      onChange={(e) => onChange(e.target.value)}
    >
      {options.map((opt) => (
        <option key={opt} value={opt}>{opt}</option>
      ))}
    </select>
  );
}

function MultiSelect({ options, value, onChange }) {
  const toggle = (opt) => {
    if (!Array.isArray(value)) onChange([opt]);
    else if (value.includes(opt)) onChange(value.filter((v) => v !== opt));
    else onChange([...value, opt]);
  };
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
      {options.map((opt) => (
        <button
          type="button"
          key={opt}
          onClick={() => toggle(opt)}
          className={`px-3 py-2 rounded-xl border text-sm text-left ${Array.isArray(value) && value.includes(opt) ? "bg-gray-900 text-white border-gray-900" : "border-gray-300 hover:bg-gray-50"}`}
        >
          {opt}
        </button>
      ))}
    </div>
  );
}
